<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Briefly - Onboarding Profile</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom animation to match 'animate-fade-in' */
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        .animate-fade-in {
            animation: fadeIn 0.5s ease-in-out;
        }

        /* Styles for selected card */
        .card-selected {
            border-color: #2563EB; /* blue-600 */
            background-color: #EFF6FF; /* blue-50 */
        }
        .card-selected .card-icon {
            color: #2563EB; /* blue-600 */
        }
        .card-selected .card-title {
            color: #111827; /* gray-900 */
        }
        .card-selected .card-description {
            color: #6B7280; /* gray-500 */
        }

        /* Styles for unselected card */
        .card-unselected {
            border-color: #E5E7EB; /* gray-200 */
            background-color: #FFFFFF; /* white */
        }
        .card-unselected:hover {
            border-color: #D1D5DB; /* gray-300 */
            background-color: #F9FAFB; /* gray-50 */
        }
        .card-unselected .card-icon {
            color: #6B7280; /* gray-500 */
        }
        .card-unselected .card-title {
            color: #111827; /* gray-900 */
        }
        .card-unselected .card-description {
            color: #6B7280; /* gray-500 */
        }

    </style>
</head>
<body class="bg-white">

    <div id="app" class="min-h-screen flex flex-col">
        <!-- Header -->
        <header class="p-6 border-b border-gray-100">
            <div class="flex items-center justify-between max-w-4xl mx-auto">
                <a href="/dashboard" class="flex items-center text-gray-600 hover:text-gray-900 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                    Back to Dashboard
                </a>
                <a href="/" class="text-2xl font-bold text-black">
                     Briefly
                </a>
                <div class="w-32"></div> 
            </div>
        </header>

        <!-- Progress Bar -->
        <div class="bg-white border-b border-gray-100 py-6">
            <div class="max-w-2xl mx-auto px-6">
                <div class="flex items-center justify-between mb-4">
                    <h1 class="text-2xl font-bold text-black">Complete Your Profile</h1>
                    <span id="step-counter" class="text-sm text-gray-500">
                        Step 1 of 3
                    </span>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2">
                    <div id="progress-bar" class="bg-black h-2 rounded-full transition-all duration-300" style="width: 33.33%;"></div>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <main class="flex-1 flex items-center justify-center px-6 py-12">
            <div class="w-full max-w-2xl">
                <!-- Step content will be injected here -->
                <div id="step-container">
                    <!-- Step 1: Learning Style - Replaced with card-style buttons -->
                    <div id="step-1" class="animate-fade-in">
                        <div class="space-y-8">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-black mb-3">Set your learning style</h2>
                                <p class="text-gray-600 text-lg">Choose how you prefer to learn to tailor your experience.</p>
                                <p class="text-sm text-gray-500 mt-2">Not sure? <a href="#" class="text-black underline hover:text-gray-800" onclick="alert('This link would lead to a page or popup explaining different learning styles (e.g., Auditory, Visual, Read/Write, Kinesthetic).'); return false;">Find out here</a></p>
                            </div>

                            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 max-w-xl mx-auto" id="learning-style-cards">
                                <!-- Audio Card -->
                                <div class="p-6 rounded-lg border cursor-pointer transition-colors duration-200 text-center flex flex-col items-center justify-center gap-3 learning-style-card" data-style="audio">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 card-icon">
                                        <rect width="7" height="19" x="12" y="2" rx="1"></rect>
                                        <path d="M12 1.7L19 8v8.3"></path>
                                        <path d="M16 20.4l-4-4.8"></path>
                                        <path d="M8 20.4l4-4.8"></path>
                                        <path d="M8 8V2.7L5 5H4a2 2 0 0 0-2 2v10a2 2 0 0 0 2 2h1a2 2 0 0 1 2 2v1a1 1 0 0 0 2 0v-1a2 2 0 0 1 2-2h1a2 2 0 0 0 2-2v-3.7"></path>
                                    </svg>
                                    <h3 class="font-semibold text-lg card-title">Audio</h3>
                                    <p class="text-sm card-description">Podcasts, lectures, spoken word</p>
                                </div>

                                <!-- Visual Card -->
                                <div class="p-6 rounded-lg border cursor-pointer transition-colors duration-200 text-center flex flex-col items-center justify-center gap-3 learning-style-card" data-style="visual">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 card-icon">
                                        <rect x="2" y="3" width="20" height="14" rx="2" ry="2"></rect>
                                        <line x1="8" y1="21" x2="16" y2="21"></line>
                                        <line x1="12" y1="17" x2="12" y2="21"></line>
                                    </svg>
                                    <h3 class="font-semibold text-lg card-title">Visual</h3>
                                    <p class="text-sm card-description">Videos, diagrams, infographics</p>
                                </div>

                                <!-- Text Card -->
                                <div class="p-6 rounded-lg border cursor-pointer transition-colors duration-200 text-center flex flex-col items-center justify-center gap-3 learning-style-card" data-style="text">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-8 h-8 card-icon">
                                        <path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"></path>
                                        <polyline points="14 2 14 8 20 8"></polyline>
                                        <line x1="16" y1="13" x2="8" y2="13"></line>
                                        <line x1="16" y1="17" x2="8" y2="17"></line>
                                        <line x1="10" y1="9" x2="8" y2="9"></line>
                                    </svg>
                                    <h3 class="font-semibold text-lg card-title">Text</h3>
                                    <p class="text-sm card-description">Articles, books, written content</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 2: Topics -->
                    <div id="step-2" class="animate-fade-in hidden">
                        <div class="space-y-8">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-black mb-3">Select topic(s) you want to learn about</h2>
                                <p class="text-gray-600 text-lg">Choose areas that interest you. You can select multiple.</p>
                            </div>
                            <div class="space-y-6">
                                <div id="topics-container" class="flex flex-wrap justify-center gap-3">
                                    <!-- Topic buttons will be injected here by JavaScript -->
                                </div>
                                <div class="flex justify-center">
                                    <button id="add-topic-button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-gray-200 bg-white hover:bg-gray-100 h-10 px-4 py-2 hover:bg-gray-50 transition-colors duration-200">
                                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="M12 5v14M5 12h14"/></svg>
                                        Add a specific topic
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Goal -->
                    <div id="step-3" class="animate-fade-in hidden">
                        <div class="space-y-8">
                            <div class="text-center mb-8">
                                <h2 class="text-3xl font-bold text-black mb-3">What is your primary goal?</h2>
                                <p class="text-gray-600 text-lg">Tell us what you hope to achieve (optional).</p>
                            </div>

                            <div class="space-y-2">
                                <label for="goal" class="text-sm font-medium text-gray-700 sr-only">Your Goal</label>
                                <textarea id="goal" placeholder="e.g., To learn Python for data analysis, to build a startup in AI, to improve leadership skills..." maxlength="250" class="flex min-h-[128px] w-full rounded-md border border-gray-200 bg-white px-3 py-2 text-base ring-offset-white placeholder:text-gray-400 focus:border-black focus:outline-none focus:ring-0 resize-none"></textarea>
                                <p id="goal-char-count" class="text-xs text-gray-500 text-right">0/250 characters</p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Navigation Buttons -->
                <div class="flex justify-between mt-12">
                    <button id="prev-button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-gray-200 bg-white hover:bg-gray-100 h-10 px-4 py-2 hover:bg-gray-50 transition-colors duration-200 disabled:cursor-not-allowed">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 mr-2"><path d="m12 19-7-7 7-7"/><path d="M19 12H5"/></svg>
                        Previous
                    </button>

                    <button id="next-button" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-black text-white hover:bg-gray-900 h-10 px-4 py-2 hover:bg-gray-800 transition-colors duration-200 disabled:bg-gray-400">
                        Next
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-2"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>
                    </button>

                    <button id="submit-button" class="hidden inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-black text-white hover:bg-gray-900 h-10 px-4 py-2 hover:bg-gray-800 transition-colors duration-200 disabled:bg-gray-400">
                        <span id="submit-button-text">Complete Profile</span>
                        <svg id="submit-button-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-4 h-4 ml-2"><path d="M20 6 9 17l-5-5"/></svg>
                    </button>
                </div>
            </div>
        </main>
    </div>

    <!-- Topic Modal -->
    <div id="topic-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden">
        <div class="bg-white rounded-lg p-6 shadow-xl w-full max-w-sm m-4">
            <h3 class="text-lg font-bold mb-4">Add Custom Topic</h3>
            <input id="custom-topic-input" type="text" placeholder="e.g., Quantum Computing" class="h-10 w-full rounded-md border border-gray-200 bg-white px-3 py-2 text-base ring-offset-white placeholder:text-gray-400 focus:border-black focus:outline-none focus:ring-0 mb-4">
            <div class="flex justify-end gap-2">
                <button id="cancel-custom-topic" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 border border-gray-200 bg-white hover:bg-gray-100 h-9 px-3 py-1">
                    Cancel
                </button>
                <button id="add-custom-topic-btn" class="inline-flex items-center justify-center whitespace-nowrap rounded-md text-sm font-medium ring-offset-white transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-gray-950 focus-visible:ring-offset-2 disabled:pointer-events-none disabled:opacity-50 bg-black text-white hover:bg-gray-900 h-9 px-3 py-1">
                    Add Topic
                </button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // --- STATE ---
            let currentStep = 1;
            let isLoading = false;
            const totalSteps = 3;
            const profileData = {
                learning_style: "", // New field for learning style
                topics: [],        // New field for topics, an array of strings
                goal: "",          // New field for user's goal
            };

            // Predefined topics for Step 2
            const predefinedTopics = [
                "Artificial Intelligence", "Machine Learning", "Blockchain", "Cybersecurity", "Data Science", "Cloud Computing",
                "Mobile Development", "Web Development", "DevOps", "Product Management", "UX/UI Design", "Digital Marketing",
                "E-commerce", "Fintech", "Healthcare Tech", "EdTech", "Startup Funding", "Venture Capital", "Angel Investing",
                "Entrepreneurship", "Leadership", "Team Management", "Business Strategy", "Sales", "Customer Success",
                "Productivity", "Personal Development", "Career Growth", "Investing", "Mindfulness", "Fitness", "Sustainability", "Biotechnology",
                "Marketing Automation", "Content Creation", "Public Speaking", "Negotiation Skills", "Financial Literacy"
            ];

            // --- DOM ELEMENTS ---
            const stepCounter = document.getElementById('step-counter');
            const progressBar = document.getElementById('progress-bar');
            const prevButton = document.getElementById('prev-button');
            const nextButton = document.getElementById('next-button');
            const submitButton = document.getElementById('submit-button');

            // Step 1 specific elements
            const learningStyleCards = document.querySelectorAll('.learning-style-card'); // Targeting the new cards

            // Step 2 specific elements
            const topicsContainer = document.getElementById('topics-container');
            const addTopicButton = document.getElementById('add-topic-button');
            const topicModal = document.getElementById('topic-modal');
            const customTopicInput = document.getElementById('custom-topic-input');
            const addCustomTopicBtn = document.getElementById('add-custom-topic-btn');
            const cancelCustomTopicBtn = document.getElementById('cancel-custom-topic');

            // Step 3 specific elements
            const goalTextarea = document.getElementById('goal');
            const goalCharCount = document.getElementById('goal-char-count');

            // --- FUNCTIONS ---
            const isStepValid = () => {
                switch (currentStep) {
                    case 1:
                        // Learning style must be selected to proceed
                        return !!profileData.learning_style;
                    case 2:
                        // Topics are optional, so this step is always valid
                        return true;
                    case 3:
                        // Goal is optional, so this step is always valid
                        return true;
                    default:
                        return false;
                }
            };

            const updateButtonState = () => {
                prevButton.disabled = currentStep === 1; // Disable 'Previous' on Step 1
                const isValid = isStepValid();

                if (currentStep === totalSteps) {
                    // On the last step, enable 'Complete Profile' only if learning_style (mandatory) is set
                    submitButton.disabled = !profileData.learning_style || isLoading;
                } else {
                    nextButton.disabled = !isValid; // Enable 'Next' if current step is valid
                }
            };

            const renderCurrentStep = () => {
                // Hide all step containers
                for (let i = 1; i <= totalSteps; i++) {
                    const stepEl = document.getElementById(`step-${i}`);
                    if (stepEl) stepEl.classList.add('hidden');
                }
                
                // Show the current step container with fade-in animation
                const currentStepElement = document.getElementById(`step-${currentStep}`);
                currentStepElement.classList.remove('hidden');
                // Re-trigger animation by removing and re-adding class
                currentStepElement.classList.remove('animate-fade-in');
                void currentStepElement.offsetWidth; // Trigger reflow for animation restart
                currentStepElement.classList.add('animate-fade-in');

                // Update progress bar and step counter text
                stepCounter.textContent = `Step ${currentStep} of ${totalSteps}`;
                progressBar.style.width = `${(currentStep / totalSteps) * 100}%`;

                // Adjust navigation buttons visibility
                if (currentStep === totalSteps) {
                    nextButton.classList.add('hidden');
                    submitButton.classList.remove('hidden');
                } else {
                    nextButton.classList.remove('hidden');
                    submitButton.classList.add('hidden');
                }
                updateButtonState();

                // Special rendering or state updates for specific steps
                if (currentStep === 1) {
                    // Highlight the selected learning style card
                    learningStyleCards.forEach(card => {
                        if (card.dataset.style === profileData.learning_style) {
                            card.classList.remove('card-unselected');
                            card.classList.add('card-selected');
                        } else {
                            card.classList.remove('card-selected');
                            card.classList.add('card-unselected');
                        }
                    });
                } else if (currentStep === 2) {
                    renderTopicButtons(); // Render topic buttons when on Step 2
                } else if (currentStep === 3) {
                    // Update character count for goal textarea
                    goalCharCount.textContent = `${profileData.goal.length}/250 characters`;
                }
            };

            const renderTopicButtons = () => {
                topicsContainer.innerHTML = ''; // Clear existing buttons

                // Combine predefined topics with any custom topics already added by the user
                // Using a Set to ensure uniqueness, then sorting for consistent display
                const allDisplayTopics = [...new Set([...predefinedTopics, ...profileData.topics])].sort((a, b) => a.localeCompare(b));

                allDisplayTopics.forEach(topic => {
                    const button = document.createElement('button');
                    button.textContent = topic;
                    // Check if the topic is currently selected by the user
                    const isSelected = profileData.topics.includes(topic);
                    button.className = `px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 ${isSelected ? 'bg-black text-white' : 'bg-gray-100 text-gray-700 hover:bg-gray-200'}`;
                    button.dataset.topic = topic; // Store topic in dataset for easy access

                    button.addEventListener('click', () => {
                        const clickedTopic = button.dataset.topic;
                        const index = profileData.topics.indexOf(clickedTopic);

                        if (index > -1) {
                            // Topic is already selected, so unselect it
                            profileData.topics.splice(index, 1);
                            button.className = 'px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-gray-100 text-gray-700 hover:bg-gray-200';
                        } else {
                            // Topic is not selected, so select it
                            profileData.topics.push(clickedTopic);
                            button.className = 'px-4 py-2 rounded-full text-sm font-medium transition-all duration-200 bg-black text-white';
                        }
                        updateButtonState(); // Update button states based on selections
                    });
                    topicsContainer.appendChild(button);
                });
            };

            // --- EVENT HANDLERS ---
            const handleNext = () => {
                if (currentStep < totalSteps) {
                    currentStep++;
                    renderCurrentStep();
                }
            };

            const handlePrevious = () => {
                if (currentStep > 1) {
                    currentStep--;
                    renderCurrentStep();
                }
            };

            const handleSubmit = async () => {
                // Ensure learning style is selected before attempting to submit
                if (!profileData.learning_style || isLoading) {
                    alert("Please select your learning style to complete your profile.");
                    return;
                }

                isLoading = true; // Set loading state to prevent multiple submissions
                const submitButtonText = document.getElementById('submit-button-text');
                const submitButtonIcon = document.getElementById('submit-button-icon');
                submitButtonText.textContent = "Creating Profile...";
                submitButtonIcon.classList.add('hidden'); // Hide icon during loading
                updateButtonState();

                const accessToken = localStorage.getItem('accessToken');
                if (!accessToken) {
                    alert("Authentication error. Please log in again.");
                    window.location.href = "/auth/login"; // Redirect to login
                    return;
                }

                // Construct payload with new onboarding fields
                const learningTypeMap = {
                    audio: 'AUDIO',
                    visual: 'VISUAL',
                    text: 'TEXT'
                };

                const payload = {
                    // API expects `learning_type` and uppercase enum values
                    learning_type: learningTypeMap[profileData.learning_style] || null,
                    // Send topics as an array of strings, or null if empty
                    topics: profileData.topics.length > 0 ? profileData.topics : null,
                    // Send goal, or null if empty
                    goal: profileData.goal || null,
                };

                try {
                    const response = await fetch('/onboarding', { // Updated URL from /v1/profile/onboard to /onboarding/
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${accessToken}`
                        },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.detail || 'Failed to complete onboarding.');
                    }

                    console.log("Onboarding Profile Completed Successfully");
                    window.location.href = "/dashboard"; // Redirect to dashboard on success

                } catch (error) {
                    alert(`Error: ${error.message}`);
                    submitButtonText.textContent = "Complete Profile"; // Restore button text
                    submitButtonIcon.classList.remove('hidden'); // Show icon
                } finally {
                    isLoading = false; // Reset loading state
                    updateButtonState();
                }
            };

            // --- INITIALIZATION ---
            prevButton.addEventListener('click', handlePrevious);
            nextButton.addEventListener('click', handleNext);
            submitButton.addEventListener('click', handleSubmit);

            // Event listener for learning style cards (Step 1)
            learningStyleCards.forEach(card => {
                card.addEventListener('click', (e) => {
                    const selectedStyle = card.dataset.style;
                    profileData.learning_style = selectedStyle;

                    // Update visual state of cards
                    learningStyleCards.forEach(c => {
                        if (c.dataset.style === selectedStyle) {
                            c.classList.remove('card-unselected');
                            c.classList.add('card-selected');
                        } else {
                            c.classList.remove('card-selected');
                            c.classList.add('card-unselected');
                        }
                    });
                    updateButtonState();
                });
            });

            // Event listener for goal textarea (Step 3)
            goalTextarea.addEventListener('input', (e) => {
                profileData.goal = e.target.value;
                goalCharCount.textContent = `${e.target.value.length}/250 characters`;
                updateButtonState();
            });

            // Event listeners for topic modal (Step 2)
            addTopicButton.addEventListener('click', () => {
                topicModal.classList.remove('hidden'); // Show modal
                customTopicInput.value = ''; // Clear previous input
                customTopicInput.focus(); // Focus input field
            });

            cancelCustomTopicBtn.addEventListener('click', () => {
                topicModal.classList.add('hidden'); // Hide modal
            });

            addCustomTopicBtn.addEventListener('click', () => {
                const customTopic = customTopicInput.value.trim();
                if (customTopic) {
                    // Check if topic (case-insensitive) already exists in selected topics
                    const normalizedCustomTopic = customTopic.toLowerCase();
                    const topicExists = profileData.topics.some(t => t.toLowerCase() === normalizedCustomTopic);

                    if (!topicExists) {
                        profileData.topics.push(customTopic); // Add new custom topic
                        renderTopicButtons(); // Re-render to show the new topic button as selected
                        updateButtonState();
                    } else {
                        alert("This topic has already been added or selected.");
                    }
                }
                topicModal.classList.add('hidden'); // Hide modal after adding or if input is empty
            });

            // Initial render of the first step when the page loads
            renderCurrentStep();
        });
    </script>
</body>
</html>